
@{
    ViewBag.Title = "Chat";
}

<style>
    .panbody{
        padding: 0 0 0 0;
    }
    .tex {
        border: none;
        max-width:2000px;
    width: 100%;
     background-color:black;
    color: white;
    font-family: Calibri;
    font-size: larger;
    height:600px;
    overflow:scroll;
}
</style>

<input id="sessinId" value="@Session.SessionID" disabled="disabled" style="display:none;" />
<div class="container">
    <!--<input type="text" id="message" />
    <input type="button" id="sendmessage" value="Send" />-->
    <input type="hidden" id="displayname" />
    <!--<ul id="discussion"></ul>-->
    <div class="col-md-8">
        <div class="panel panel-success">
            <div class="panel-heading">
                <b>CODE EDITOR</b>
                <span class="pull-right">
                    <label>Select Language</label>
                    <select id="modeselect">
                        <option>c_cpp</option>
                        <option>csharp</option>
                        <option>css</option>
                        <option>html</option>
                        <option>html_ruby</option>
                        <option>java</option>
                        <option>javascript</option>
                        <option>mysql</option>
                        <option>perl</option>
                        <option>php</option>
                        <option>python</option>
                        <option>r</option>
                        <option>ruby</option>
                        <option>typescript</option>
                        <option>xml</option>
                    </select>
                </span>
            </div>
            <div id="codearea" style="height:600px;">
            </div>
            <!--<div class="panel-body panbody" id="codearea">
                <textarea class="tex" id="codearea"></textarea>
            </div>-->
        </div>
    </div>
    <div class="col-md-4">
        <div class="panel panel-primary">
            <div class="panel-heading"><b>CHAT</b></div>
            <div class="panel-body" id="chatbody" style="height:550px;overflow:scroll"></div>
            <div class="panel-footer panbody"><textarea id="chatmsg" style="height:50px;width:100%;max-width:500px;" class="form-control"></textarea></div>
        </div>
    </div>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/diff_match_patch.js"></script>
    <script src="~/Scripts/jquery.signalR-2.1.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script src="~/Scripts/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var editor = ace.edit("codearea");
            editor.setTheme("ace/theme/monokai");
            editor.getSession().setMode("ace/mode/c_cpp");
            editor.setFontSize(16);
            var chat = $.connection.chatHub;

            var dmp = new diff_match_patch();
            // Create a function that the hub can call back to display messages.

            chat.client.changeLanguageMode = function (newmode) {
                $('#modeselect').val(newmode);
                editor.getSession().setMode("ace/mode/" + newmode);
            }

            chat.client.addNewMessageToPage = function (sessnId, message) {
                var sessId = $('#sessinId').val();
                if (sessId != sessnId)
                {
                    dmp.Match_Distance = 1000;
                    dmp.Match_Threshold = 0.5;
                    dmp.Patch_DeleteThreshold = 0.5;

                    var patches = dmp.patch_make(editor.getValue(), message);
                    var results = dmp.patch_apply(patches, editor.getValue());
                    editor.setValue(results[0]);
                }
                // Add the message to the page.
                //$('#discussion').append('<li><strong>' + htmlEncode(name)
                //  + '</strong>: ' + htmlEncode(message) + '</li>');
                //$('#codearea').html(htmlEncode(message));
                //console.log(message);
            };

            chat.client.addChatMessageToPage = function (disp, message) {
                $('#chatbody').append('<li><strong>' + htmlEncode(disp)
                  + '</strong>: ' + htmlEncode(message) + '</li>');
            };

            // Get the user name and store it to prepend to messages.
            $('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            //$('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#codearea').keyup(function(event){
                //$('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#sessinId').val(), editor.getValue());
                    //chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    //$('#message').val('').focus();
                });

                $('#chatmsg').keypress(function (e) {
                    if (e.which == 13) {
                        if ($('#chatmsg').val() != "") { chat.server.sand($('#displayname').val(), $('#chatmsg').val()); }
                        $('#chatmsg').val("");
                        return false;    //<---- Add this line
                    }
                });

                $('#modeselect').change(function () {
                    chat.server.modesend($(this).val());
                    //editor.getSession().setMode("ace/mode/" + $(this).val());
                })
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}
